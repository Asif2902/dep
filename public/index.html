<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonBridgeDex - Monad Testnet</title>
    <script src="https://monbridgedex.xyz/ethers.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .network-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .network-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .wallet-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .connect-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connect-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .connect-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .router-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .router-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .router-address {
            font-family: monospace;
            font-size: 0.9em;
            color: #555;
            word-break: break-all;
        }

        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .result-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .result-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .result-item {
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }

        .result-value {
            font-family: monospace;
            color: #333;
            word-break: break-all;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 25px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .swap-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .swap-preview h3 {
            margin-bottom: 15px;
        }

        .swap-route {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .swap-token {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .swap-arrow {
            font-size: 1.5em;
        }

        .info-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }

        .warning-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .error-box {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ MonBridgeDex Interface</h1>
            <p>Production-Grade DEX Aggregator on Monad Testnet</p>
            <div class="network-info">
                <div class="network-badge">Chain ID: 143</div>
                <div class="network-badge">RPC: rpc.monad.xyz</div>
                <div class="network-badge" id="blockNumber">Block: Loading...</div>
            </div>
        </div>

        <div class="wallet-section">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <button class="connect-btn" id="connectWallet">Connect Wallet</button>
                    <span id="walletAddress" style="margin-left: 15px; font-family: monospace;"></span>
                </div>
                <div class="form-group" style="margin: 0; max-width: 400px;">
                    <label>Contract Address:</label>
                    <input type="text" id="contractAddress" value="0x7Db8Be2395E0a85269333CA99312c409A5B409f9" readonly style="font-family: monospace; background-color: #f5f5f5;">
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Router Management Card -->
            <div class="card">
                <h2>üì° Router Management</h2>

                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('v2Router')">Add V2 Router</button>
                    <button class="tab" onclick="switchTab('v3Router')">Add V3 Router</button>
                    <button class="tab" onclick="switchTab('viewRouters')">View Routers</button>
                </div>

                <!-- V2 Router Tab -->
                <div id="v2Router" class="tab-content active">
                    <div class="form-group">
                        <label>V2 Router Address:</label>
                        <input type="text" id="v2RouterAddress" placeholder="0x...">
                    </div>
                    <button class="btn" onclick="addV2Router()">Add V2 Router</button>
                </div>

                <!-- V3 Router Tab -->
                <div id="v3Router" class="tab-content">
                    <div class="form-group">
                        <label>V3 Router Address:</label>
                        <input type="text" id="v3RouterAddress" placeholder="0x...">
                    </div>
                    <div class="form-group">
                        <label>V3 Factory Address:</label>
                        <input type="text" id="v3FactoryAddress" placeholder="0x...">
                    </div>
                    <button class="btn" onclick="addV3Router()">Add V3 Router</button>
                </div>

                <!-- View Routers Tab -->
                <div id="viewRouters" class="tab-content">
                    <button class="btn" onclick="loadRouters()">Refresh Router Lists</button>

                    <h3 style="margin-top: 20px; color: #667eea;">V2 Routers</h3>
                    <div class="router-list" id="v2RouterList">
                        <p style="text-align: center; color: #999;">No routers loaded</p>
                    </div>

                    <h3 style="margin-top: 20px; color: #667eea;">V3 Routers</h3>
                    <div class="router-list" id="v3RouterList">
                        <p style="text-align: center; color: #999;">No routers loaded</p>
                    </div>
                </div>
            </div>

            <!-- Find Best Router Card -->
            <div class="card">
                <h2>üîç Find Best Router</h2>

                <div class="form-group">
                    <label>Amount In (in token units):</label>
                    <input type="text" id="findAmountIn" placeholder="1000000000000000000">
                </div>

                <div class="form-group">
                    <label>Token In Address:</label>
                    <input type="text" id="findTokenIn" placeholder="0x...">
                </div>

                <div class="form-group">
                    <label>Token Out Address:</label>
                    <input type="text" id="findTokenOut" placeholder="0x...">
                </div>

                <div class="form-group">
                    <label>User Slippage (BPS, 0 for auto):</label>
                    <input type="number" id="findSlippage" placeholder="50" value="50">
                    <small style="color: #666;">100 BPS = 1%</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="findFeeOnTransfer" style="width: auto; margin-right: 8px;">
                        Support Fee-On-Transfer Tokens
                    </label>
                </div>

                <button class="btn btn-success" onclick="findBestRouter()">Find Best Route</button>

                <div id="routeResult"></div>
            </div>
        </div>

        <!-- Execute Swap Card (Full Width) -->
        <div class="card">
            <h2>‚ö° Execute Swap</h2>

            <div class="info-box">
                <strong>üí° Tip:</strong> Use "Find Best Router" first to get optimal swap data, then paste the values here to execute.
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="form-group">
                    <label>Swap Type:</label>
                    <select id="swapType">
                        <option value="0">ETH to Token</option>
                        <option value="1">Token to ETH</option>
                        <option value="2">Token to Token</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Router Type:</label>
                    <select id="routerType">
                        <option value="0">V2</option>
                        <option value="1">V3</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Router Address:</label>
                    <input type="text" id="execRouterAddress" placeholder="0x...">
                </div>

                <div class="form-group">
                    <label>Amount In (wei/smallest unit):</label>
                    <input type="text" id="execAmountIn" placeholder="1000000000000000000">
                </div>

                <div class="form-group">
                    <label>Min Amount Out (wei/smallest unit):</label>
                    <input type="text" id="execAmountOutMin" placeholder="900000000000000000">
                </div>

                <div class="form-group">
                    <label>Deadline (unix timestamp):</label>
                    <input type="text" id="execDeadline" placeholder="0">
                </div>
            </div>

            <div class="form-group">
                <label>Path (comma-separated addresses):</label>
                <input type="text" id="execPath" placeholder="0xToken1,0xToken2,0xToken3">
                <small style="color: #666;">For ETH swaps, use WETH address in path</small>
            </div>

            <div class="form-group">
                <label>V3 Fees (comma-separated, only for V3 multi-hop):</label>
                <input type="text" id="execV3Fees" placeholder="500,3000">
                <small style="color: #666;">Common tiers: 100, 500, 3000, 10000</small>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="execFeeOnTransfer" style="width: auto; margin-right: 8px;">
                    Support Fee-On-Transfer Tokens
                </label>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="executeSwap()">Execute Swap</button>
                <button class="btn" onclick="approveToken()">Approve Token (for Token swaps)</button>
            </div>

            <div id="swapResult"></div>
        </div>

        <!-- Transaction Log -->
        <div class="card">
            <h2>üìù Transaction Log</h2>
            <div id="txLog" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: #999;">No transactions yet</p>
            </div>
        </div>
    </div>

    <script>
        const MONAD_CHAIN_ID = 143;
        const MONAD_RPC = 'https://rpc.monad.xyz';

        let provider;
        let signer;
        let contract;
        let walletConnected = false;

        const ABI = [
            "function addRouter(address _router) external",
            "function addV3Router(address _router, address _factory) external",
            "function getRouters() external view returns (address[])",
            "function getV3Routers() external view returns (address[])",
            "function getBestSwapData(uint amountIn, address[] calldata path, bool supportFeeOnTransfer, uint16 userSlippageBPS) external view returns (tuple(uint8 swapType, uint8 routerType, address router, address[] path, uint24[] v3Fees, uint amountIn, uint amountOutMin, uint deadline, bool supportFeeOnTransfer))",
            "function execute(tuple(uint8 swapType, uint8 routerType, address router, address[] path, uint24[] v3Fees, uint amountIn, uint amountOutMin, uint deadline, bool supportFeeOnTransfer) swapData) external payable returns (uint amountOut)",
            "function owner() external view returns (address)",
            "function WETH() external view returns (address)"
        ];

        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function balanceOf(address account) external view returns (uint256)",
            "function decimals() external view returns (uint8)",
            "function symbol() external view returns (string)"
        ];

        // Initialize
        window.addEventListener('load', async () => {
            await initializeProvider();
            updateBlockNumber();
            setInterval(updateBlockNumber, 15000);

            // Set default deadline
            document.getElementById('execDeadline').value = Math.floor(Date.now() / 1000) + 300;
        });

        async function initializeProvider() {
            try {
                provider = new ethers.providers.JsonRpcProvider(MONAD_RPC);
                log('Provider initialized', 'info');
            } catch (error) {
                log('Failed to initialize provider: ' + error.message, 'error');
            }
        }

        async function updateBlockNumber() {
            try {
                const blockNumber = await provider.getBlockNumber();
                document.getElementById('blockNumber').textContent = `Block: ${blockNumber}`;
            } catch (error) {
                document.getElementById('blockNumber').textContent = 'Block: Error';
            }
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask or another Web3 wallet');
                    return;
                }

                const web3Provider = new ethers.providers.Web3Provider(window.ethereum);
                await web3Provider.send("eth_requestAccounts", []);

                const network = await web3Provider.getNetwork();
                if (network.chainId !== MONAD_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + MONAD_CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + MONAD_CHAIN_ID.toString(16),
                                    chainName: 'Monad Testnet',
                                    nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
                                    rpcUrls: [MONAD_RPC],
                                }],
                            });
                        }
                    }
                }

                signer = web3Provider.getSigner();
                const address = await signer.getAddress();

                document.getElementById('walletAddress').textContent = `Connected: ${address.slice(0, 6)}...${address.slice(-4)}`;
                document.getElementById('connectWallet').textContent = 'Connected ‚úì';
                document.getElementById('connectWallet').disabled = true;

                walletConnected = true;
                log(`Wallet connected: ${address}`, 'success');

                initializeContract();
            } catch (error) {
                log('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        function initializeContract() {
            const contractAddress = document.getElementById('contractAddress').value;
            if (!contractAddress || !ethers.utils.isAddress(contractAddress)) {
                log('Invalid contract address', 'error');
                return false;
            }

            try {
                contract = new ethers.Contract(contractAddress, ABI, signer || provider);
                log('Contract initialized at ' + contractAddress, 'success');
                return true;
            } catch (error) {
                log('Failed to initialize contract: ' + error.message, 'error');
                return false;
            }
        }

        async function addV2Router() {
            if (!walletConnected) {
                alert('Please connect wallet first');
                return;
            }

            if (!initializeContract()) return;

            const routerAddress = document.getElementById('v2RouterAddress').value;

            if (!ethers.utils.isAddress(routerAddress)) {
                alert('Invalid router address');
                return;
            }

            try {
                log('Adding V2 router...', 'info');
                const tx = await contract.addRouter(routerAddress);
                log(`Transaction sent: ${tx.hash}`, 'info');

                await tx.wait();
                log(`V2 Router added: ${routerAddress}`, 'success');

                document.getElementById('v2RouterAddress').value = '';
            } catch (error) {
                log('Failed to add V2 router: ' + error.message, 'error');
            }
        }

        async function addV3Router() {
            if (!walletConnected) {
                alert('Please connect wallet first');
                return;
            }

            if (!initializeContract()) return;

            const routerAddress = document.getElementById('v3RouterAddress').value;
            const factoryAddress = document.getElementById('v3FactoryAddress').value;

            if (!ethers.utils.isAddress(routerAddress) || !ethers.utils.isAddress(factoryAddress)) {
                alert('Invalid router or factory address');
                return;
            }

            try {
                log('Adding V3 router...', 'info');
                const tx = await contract.addV3Router(routerAddress, factoryAddress);
                log(`Transaction sent: ${tx.hash}`, 'info');

                await tx.wait();
                log(`V3 Router added: ${routerAddress}`, 'success');

                document.getElementById('v3RouterAddress').value = '';
                document.getElementById('v3FactoryAddress').value = '';
            } catch (error) {
                log('Failed to add V3 router: ' + error.message, 'error');
            }
        }

        async function loadRouters() {
            if (!initializeContract()) return;

            try {
                log('Loading routers...', 'info');

                const v2Routers = await contract.getRouters();
                const v3Routers = await contract.getV3Routers();

                const v2List = document.getElementById('v2RouterList');
                const v3List = document.getElementById('v3RouterList');

                if (v2Routers.length === 0) {
                    v2List.innerHTML = '<p style="text-align: center; color: #999;">No V2 routers configured</p>';
                } else {
                    v2List.innerHTML = v2Routers.map(addr => 
                        `<div class="router-item">
                            <span class="router-address">${addr}</span>
                            <span class="status status-success">Active</span>
                        </div>`
                    ).join('');
                }

                if (v3Routers.length === 0) {
                    v3List.innerHTML = '<p style="text-align: center; color: #999;">No V3 routers configured</p>';
                } else {
                    v3List.innerHTML = v3Routers.map(addr => 
                        `<div class="router-item">
                            <span class="router-address">${addr}</span>
                            <span class="status status-success">Active</span>
                        </div>`
                    ).join('');
                }

                log(`Loaded ${v2Routers.length} V2 and ${v3Routers.length} V3 routers`, 'success');
            } catch (error) {
                log('Failed to load routers: ' + error.message, 'error');
            }
        }

        async function findBestRouter() {
            if (!initializeContract()) return;

            const amountIn = document.getElementById('findAmountIn').value;
            const tokenIn = document.getElementById('findTokenIn').value;
            const tokenOut = document.getElementById('findTokenOut').value;
            const slippage = document.getElementById('findSlippage').value || 50;
            const feeOnTransfer = document.getElementById('findFeeOnTransfer').checked;

            if (!amountIn || !ethers.utils.isAddress(tokenIn) || !ethers.utils.isAddress(tokenOut)) {
                alert('Please fill all fields with valid addresses');
                return;
            }

            try {
                log('Finding best route...', 'info');

                const path = [tokenIn, tokenOut];
                const result = await contract.getBestSwapData(
                    amountIn,
                    path,
                    feeOnTransfer,
                    slippage
                );

                displayRouteResult(result, amountIn, path);
                log('Best route found', 'success');
            } catch (error) {
                log('Failed to find best route: ' + error.message, 'error');
                document.getElementById('routeResult').innerHTML = 
                    `<div class="error-box"><strong>Error:</strong> ${error.message}</div>`;
            }
        }

        function displayRouteResult(result, amountIn, originalPath) {
            const swapTypes = ['ETH_TO_TOKEN', 'TOKEN_TO_ETH', 'TOKEN_TO_TOKEN'];
            const routerTypes = ['V2', 'V3'];

            const html = `
                <div class="result-box">
                    <h3>‚úÖ Best Route Found</h3>

                    <div class="swap-preview">
                        <h3>Route Preview</h3>
                        <div class="swap-route">
                            ${result.path.map((token, i) => `
                                <div class="swap-token">${token.slice(0, 6)}...${token.slice(-4)}</div>
                                ${i < result.path.length - 1 ? '<span class="swap-arrow">‚Üí</span>' : ''}
                            `).join('')}
                        </div>
                        <div style="margin-top: 15px;">
                            <div><strong>Type:</strong> ${swapTypes[result.swapType]}</div>
                            <div><strong>Router Type:</strong> ${routerTypes[result.routerType]}</div>
                            <div><strong>Expected Out:</strong> ${ethers.utils.formatUnits(result.amountOutMin, 18)}</div>
                        </div>
                    </div>

                    <div class="result-item">
                        <div class="result-label">Swap Type:</div>
                        <div class="result-value">${result.swapType} (${swapTypes[result.swapType]})</div>
                    </div>


                    <div class="result-item">
                        <div class="result-label">Min Amount Out:</div>
                        <div class="result-value">${result.amountOutMin.toString()}</div>
                    </div>

                    <div class="result-item">
                        <div class="result-label">Deadline:</div>
                        <div class="result-value">${result.deadline.toString()} (${new Date(result.deadline * 1000).toLocaleString()})</div>
                    </div>

                    <div class="result-item">
                        <div class="result-label">Fee-On-Transfer:</div>
                        <div class="result-value">${result.supportFeeOnTransfer ? 'Yes' : 'No'}</div>
                    </div>

                    <div class="warning-box" style="margin-top: 20px;">
                        <strong>üìã Copy these values to "Execute Swap" section to perform the trade</strong>
                    </div>

                    <button class="btn btn-success" onclick="autoFillSwapData(${JSON.stringify(result).replace(/"/g, '&quot;')})">
                        Auto-Fill Execute Form
                    </button>
                </div>
            `;

            document.getElementById('routeResult').innerHTML = html;
        }

        function autoFillSwapData(result) {
            document.getElementById('swapType').value = result.swapType;
            document.getElementById('routerType').value = result.routerType;
            document.getElementById('execRouterAddress').value = result.router;
            document.getElementById('execAmountIn').value = result.amountIn.toString();
            document.getElementById('execAmountOutMin').value = result.amountOutMin.toString();
            document.getElementById('execDeadline').value = result.deadline.toString();
            document.getElementById('execPath').value = result.path.join(',');
            document.getElementById('execV3Fees').value = result.v3Fees.join(',');
            document.getElementById('execFeeOnTransfer').checked = result.supportFeeOnTransfer;

            // Scroll to execute section
            document.querySelector('.card:nth-child(3)').scrollIntoView({ behavior: 'smooth' });
            log('Swap data auto-filled', 'success');
        }

        async function approveToken() {
            if (!walletConnected) {
                alert('Please connect wallet first');
                return;
            }

            const contractAddress = document.getElementById('contractAddress').value;
            if (!ethers.utils.isAddress(contractAddress)) {
                alert('Invalid contract address');
                return;
            }

            const pathStr = document.getElementById('execPath').value;
            if (!pathStr) {
                alert('Please enter token path');
                return;
            }

            const path = pathStr.split(',').map(addr => addr.trim());
            const tokenAddress = path[0];

            if (!ethers.utils.isAddress(tokenAddress)) {
                alert('Invalid token address in path');
                return;
            }

            try {
                log('Approving token...', 'info');

                const tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                const maxApproval = ethers.constants.MaxUint256;

                const tx = await tokenContract.approve(contractAddress, maxApproval);
                log(`Approval transaction sent: ${tx.hash}`, 'info');

                await tx.wait();
                log(`Token approved: ${tokenAddress}`, 'success');
            } catch (error) {
                log('Failed to approve token: ' + error.message, 'error');
            }
        }

        async function executeSwap() {
            if (!walletConnected) {
                alert('Please connect wallet first');
                return;
            }

            if (!initializeContract()) return;

            const swapType = parseInt(document.getElementById('swapType').value);
            const routerType = parseInt(document.getElementById('routerType').value);
            const router = document.getElementById('execRouterAddress').value;
            const amountIn = document.getElementById('execAmountIn').value;
            const amountOutMin = document.getElementById('execAmountOutMin').value;
            const deadline = document.getElementById('execDeadline').value;
            const pathStr = document.getElementById('execPath').value;
            const v3FeesStr = document.getElementById('execV3Fees').value;
            const feeOnTransfer = document.getElementById('execFeeOnTransfer').checked;

            if (!ethers.utils.isAddress(router)) {
                alert('Invalid router address');
                return;
            }

            const path = pathStr.split(',').map(addr => addr.trim());
            const v3Fees = v3FeesStr ? v3FeesStr.split(',').map(fee => parseInt(fee.trim())) : [500];

            for (let addr of path) {
                if (!ethers.utils.isAddress(addr)) {
                    alert(`Invalid address in path: ${addr}`);
                    return;
                }
            }

            const swapData = {
                swapType,
                routerType,
                router,
                path,
                v3Fees,
                amountIn,
                amountOutMin,
                deadline,
                supportFeeOnTransfer: feeOnTransfer
            };

            try {
                log('Executing swap...', 'info');
                log(`Swap details: ${JSON.stringify(swapData, null, 2)}`, 'info');

                const options = {};
                if (swapType === 0) { // ETH_TO_TOKEN
                    options.value = amountIn;
                }

                const tx = await contract.execute(swapData, options);
                log(`Swap transaction sent: ${tx.hash}`, 'info');

                const receipt = await tx.wait();
                log(`Swap executed successfully! Gas used: ${receipt.gasUsed.toString()}`, 'success');

                document.getElementById('swapResult').innerHTML = `
                    <div class="result-box">
                        <h3>‚úÖ Swap Executed Successfully</h3>
                        <div class="result-item">
                            <div class="result-label">Transaction Hash:</div>
                            <div class="result-value">${receipt.transactionHash}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Block Number:</div>
                            <div class="result-value">${receipt.blockNumber}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Gas Used:</div>
                            <div class="result-value">${receipt.gasUsed.toString()}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Status:</div>
                            <div class="result-value">${receipt.status === 1 ? 'Success ‚úÖ' : 'Failed ‚ùå'}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                log('Failed to execute swap: ' + error.message, 'error');
                document.getElementById('swapResult').innerHTML = `
                    <div class="error-box">
                        <strong>Swap Failed:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('txLog');
            const timestamp = new Date().toLocaleTimeString();

            let statusClass = 'status-info';
            if (type === 'success') statusClass = 'status-success';
            if (type === 'error') statusClass = 'status-error';

            const logEntry = document.createElement('div');
            logEntry.className = 'router-item';
            logEntry.innerHTML = `
                <div style="flex: 1;">
                    <div style="color: #999; font-size: 0.85em;">${timestamp}</div>
                    <div style="margin-top: 5px;">${message}</div>
                </div>
                <span class="status ${statusClass}">${type.toUpperCase()}</span>
            `;

            if (logDiv.querySelector('p')) {
                logDiv.innerHTML = '';
            }

            logDiv.insertBefore(logEntry, logDiv.firstChild);

            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Connect wallet button
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
    </script>
</body>
</html>